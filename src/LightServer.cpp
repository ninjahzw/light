#include <thrift/concurrency/ThreadManager.h>
#include <thrift/concurrency/PosixThreadFactory.h>
#include <thrift/protocol/TBinaryProtocol.h>
#include <thrift/server/TSimpleServer.h>
#include <thrift/server/TThreadPoolServer.h>
#include <thrift/server/TThreadedServer.h>
#include <thrift/transport/TServerSocket.h>
#include <thrift/transport/TTransportUtils.h>
#include <thrift/TToString.h>
#include <glog/logging.h>

#include <iostream>
#include <stdexcept>
#include <sstream>

#include "LightServiceHandler.h"

using namespace std;
using namespace apache::thrift;
using namespace apache::thrift::concurrency;
using namespace apache::thrift::protocol;
using namespace apache::thrift::transport;
using namespace apache::thrift::server;

using namespace light::service;

int main(int argc, char *argv[]) {
  boost::shared_ptr<TProtocolFactory> protocolFactory(
      new TBinaryProtocolFactory());
  boost::shared_ptr<LightServiceHandler> handler(new LightServiceHandler());
  boost::shared_ptr<TProcessor> processor(new LightServiceProcessor(handler));
  boost::shared_ptr<TServerTransport> serverTransport(new TServerSocket(9090));
  boost::shared_ptr<TTransportFactory> transportFactory(
      new TBufferedTransportFactory());

  boost::shared_ptr<ThreadManager> threadManager =
      ThreadManager::newSimpleThreadManager(10);
  boost::shared_ptr<PosixThreadFactory> threadFactory =
      boost::shared_ptr<PosixThreadFactory>(new PosixThreadFactory());
  threadManager->threadFactory(threadFactory);
  threadManager->start();

  TThreadPoolServer server(processor, serverTransport, transportFactory,
                           protocolFactory, threadManager);

  cout << "Starting the server..." << endl;
  server.serve();
  cout << "Done." << endl;
  return 0;
}
